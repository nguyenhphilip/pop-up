<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Pop-up Hang</title>
  <style>
    body { font-family: sans-serif; max-width: 500px; margin: auto; padding: 1em; }
    h1 { text-align: center; color: #2a5db0; }
    h2 { margin-top: 1.5em; color: #333; }
    .broadcast {
      text-align: center;
      padding: 0.6em;
      border: 1px solid #ccc;
      margin-bottom: 0.5em;
      border-radius: 6px;
      transition: background-color 0.6s ease, color 0.6s ease, opacity 0.6s ease;
    }
    .broadcast.new {
      background-color: #e7f3ff;
      animation: fadeOut 3s forwards;
    }
    @keyframes fadeOut {
      0% { background-color: #e7f3ff; }
      100% { background-color: white; }
    }

    /* Soon-expiring visual */
    .broadcast.soon {
      background-color: #fff3cd;
      border-color: #e0c36d;
    }
    .broadcast.expired {
      opacity: 0.6;
      color: #777;
    }

    input, select, button, textarea {
      width: 100%;
      margin: 0.4em 0;
      padding: 0.6em;
      border-radius: 5px;
      border: 1px solid #ccc;
      font-size: 1em;
    }
    button {
      background: #2a5db0;
      color: white;
      border: none;
      font-weight: bold;
      transition: opacity 0.2s ease;
    }
    button:hover { background: #1f4b91; cursor: pointer; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }

    .out { background: #33b133; }
    .done { background: #ac6772; }

    #no-listings { text-align: center; color: #888; font-style: italic; margin-top: 1em; }
    #last-updated { text-align: center; color: #777; font-size: 0.9em; margin-top: 0.5em; }

    /* Loading spinner */
    .spinner {
      display: none;
      text-align: center;
      margin-top: 1em;
    }
    .spinner:after {
      content: "";
      display: inline-block;
      width: 18px;
      height: 18px;
      border: 3px solid #2a5db0;
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      vertical-align: middle;
      margin-left: 5px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <h1>POP-UP HANG</h1>
  <div id="desc">
    <p>Broadcast spontaneous hangouts to your friends or community.</p>
    <p>Every listing will expire after the amount of time set. (The unspecified duration hangs/pop-up events will expire after 12 hours.)</p>
  </div>
  <hr>
  <h2 style="text-align: center;">Current happenings</h2>
  <div class="spinner" id="loading-indicator">Loading</div>
    <div id="list"></div>
    <div id="no-listings" style="display:none;">There are no listings at the moment.</div>
    <div id="last-updated"></div>
    <hr>

  <div id="form">
    <h2 style="text-align: center;">Create a listing</h2>
    <form id="popup-form" autocomplete="off" novalidate>
        <label for="user">Name:</label><input name="user_name" id="user" placeholder="e.g. Phil Nguyen" autocomplete="name" inputmode="text" name="note" autocapitalize="words">
        <label for="user">Description/Location:</label><textarea id="note"name="popup_note" placeholder="e.g. Coffee at Pan Pan in Greenpoint" rows="3" autocomplete="off" autocorrect="on" spellcheck="true" autocapitalize="sentences" aria-label="Description of your hangout" style="width: 100%; margin: 0.4em 0; padding: 0.6em; border-radius: 5px; border: 1px solid #ccc; resize: vertical;"></textarea>
        <label for="user">Duration:</label>
        <select name="duration" id="duration">
        <option value="1">1 hour</option>
        <option value="2" selected>2 hours</option>
        <option value="3">3 hours</option>
        <option value="unspecified">Unspecified</option>
        </select>
        <br>
        <br>
        <button type="button" onclick="getLocation()">üìç Share My Location (optional)</button>
        <input type="hidden" id="lat">
        <input type="hidden" id="lon">
        <button type="button" class="out" onclick="postBroadcast()">Create your listing</button>
        <p>To remove your listing early, click below:</p>
        <button type="button" class="done" onclick="deleteMyBroadcast()">I‚Äôm done!</button>
    </form>
  </div>

     <script>
    const api = "/broadcasts";
    const spinner = document.getElementById("loading-indicator");

    function setLoading(show) {
      spinner.style.display = show ? "block" : "none";
    }

    async function postBroadcast() {
      const btn = document.querySelector(".out");
      btn.disabled = true;
      const original = btn.textContent;
      btn.textContent = "Posting...";

      try {
        const user = document.getElementById("user").value.trim();
        const note = document.getElementById("note").value.trim();
        const durationValue = document.getElementById("duration").value;
        const duration_hours = durationValue === "unspecified" ? null : Number(durationValue);
        const lat = document.getElementById("lat").value || null;
        const lon = document.getElementById("lon").value || null;
        if (!user || !note) {
          alert("Enter your name and description first!");
          return;
        }

        localStorage.setItem("username", user);

        // Optimistic display
        const list = document.getElementById("list");
        const temp = document.createElement("div");
        temp.className = "broadcast new";
        temp.innerHTML = `<b>${user}</b> ‚Äî ${note} (posting...)`;
        list.prepend(temp);

        const res = await fetch(api, {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({ user, note, duration_hours, lat, lon })
        });

        if (!res.ok) throw new Error(await res.text());
        const data = await res.json();
        if (data.delete_token) localStorage.setItem("delete_token", data.delete_token);

        document.getElementById("note").value = "";
        document.getElementById("lat").value = "";
        document.getElementById("lon").value = "";
        await loadBroadcasts();
      } catch (err) {
        console.error("Broadcast error:", err);
        alert("Could not post broadcast. Try again.");
      } finally {
        btn.disabled = false;
        btn.textContent = original;
      }
    }

    async function deleteMyBroadcast() {
      const token = localStorage.getItem("delete_token");
      if (!token) return alert("No active broadcast found.");
      const btn = document.querySelector(".done");
      btn.disabled = true;
      const original = btn.textContent;
      btn.textContent = "Removing...";
      try {
        const res = await fetch("/delete_broadcast", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({ delete_token: token })
        });
        if (res.ok) {
          alert("Your broadcast has been cleared!");
          localStorage.removeItem("delete_token");
          loadBroadcasts();
        } else {
          alert("Could not delete broadcast. Maybe it already expired?");
        }
      } finally {
        btn.disabled = false;
        btn.textContent = original;
      }
    }

    function getLocation() {
      if (!navigator.geolocation) return alert("Geolocation not supported.");
      navigator.geolocation.getCurrentPosition(pos => {
        document.getElementById("lat").value = pos.coords.latitude;
        document.getElementById("lon").value = pos.coords.longitude;
        alert("Location attached for this post.");
      }, err => {
        console.error(err);
        alert("Could not get location. Check permissions.");
      });
    }

    async function loadBroadcasts() {
      setLoading(true);
      const res = await fetch(api);
      const data = await res.json();
      const list = document.getElementById("list");
      const noListings = document.getElementById("no-listings");
      const lastUpdated = document.getElementById("last-updated");
      list.innerHTML = "";

      if (data.length === 0) {
        noListings.style.display = "block";
      } else {
        noListings.style.display = "none";
        const now = new Date();
        data.forEach(b => {
          const div = document.createElement("div");
          div.className = "broadcast";

          const expTime = new Date(b.expires_at);
          const minsLeft = (expTime - now) / 60000;

          let line = `<b>${b.user}</b> ‚Äî ${b.note}`;
          if (b.duration_hours === null) {
            line += ` (time unspecified)`;
          } else {
            const end = expTime.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            if (minsLeft <= 30) {
              line += ` (until ${end}, <em>expiring soon</em>)`;
              div.classList.add("soon");
            } else {
              line += ` (until ${end})`;
            }
          }

          if (minsLeft <= 0) {
            div.classList.add("expired");
          }

          if (b.lat && b.lon) {
            const osm = `https://www.openstreetmap.org/?mlat=${b.lat}&mlon=${b.lon}#map=16/${b.lat}/${b.lon}`;
            line += ` <a href="${osm}" target="_blank">üìçMap</a>`;
          }

          div.innerHTML = line;
          list.appendChild(div);
        });
      }

      const nowTime = new Date();
      lastUpdated.textContent = `[Last updated: ${nowTime.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}]`;
      setLoading(false);
    }

    // ---------- SSE Live Updates ----------
    if ("EventSource" in window) {
      const evt = new EventSource("/stream");
      evt.addEventListener("new_broadcast", e => loadBroadcasts());
      evt.addEventListener("refresh", e => loadBroadcasts());
    } else {
      setInterval(loadBroadcasts, 60000);
    }

    document.getElementById("user").value = localStorage.getItem("username") || "";
    loadBroadcasts();
  </script>
</body>
</html>
