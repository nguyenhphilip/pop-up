<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Pop-up Hang</title>
  <style>
    body { font-family: sans-serif; max-width: 500px; margin: auto; padding: 1em; }
    h1 { text-align: center; color: #2a5db0; }
    h2 { margin-top: 1.5em; color: #333; }
    .broadcast {
      text-align: center;
      padding: 0.6em;
      border: 1px solid #ccc;
      margin-bottom: 0.5em;
      border-radius: 6px;
      transition: background-color 0.6s ease, color 0.6s ease, opacity 0.6s ease;
    }
    .broadcast.new {
      background-color: #e7f3ff;
      animation: fadeOut 3s forwards;
    }
    @keyframes fadeOut {
      0% { background-color: #e7f3ff; }
      100% { background-color: white; }
    }

    /* Soon-expiring visual */
    .broadcast.soon {
      background-color: #fff3cd;
      border-color: #e0c36d;
    }
    .broadcast.expired {
      opacity: 0.6;
      color: #777;
    }

    input, select, button, textarea {
      width: 100%;
      margin: 0.4em 0;
      padding: 0.6em;
      border-radius: 5px;
      border: 1px solid #ccc;
      font-size: 1em;
    }
    button {
      background: #2a5db0;
      color: white;
      border: none;
      font-weight: bold;
      transition: opacity 0.2s ease;
    }
    button:hover { background: #1f4b91; cursor: pointer; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }

    .out { background: #33b133; }
    .done { background: #ac6772; }

    #no-listings { text-align: center; color: #888; font-style: italic; margin-top: 1em; }
    #last-updated { text-align: center; color: #777; font-size: 0.9em; margin-top: 0.5em; }

    /* Loading spinner */
    .spinner {
      display: none;
      text-align: center;
      margin-top: 1em;
    }
    .spinner:after {
      content: "";
      display: inline-block;
      width: 18px;
      height: 18px;
      border: 3px solid #2a5db0;
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      vertical-align: middle;
      margin-left: 5px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Toast notifications */
    #toast-container {
        position: fixed;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1000;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px; /* auto-spacing between stacked toasts */
        pointer-events: none; /* clicks pass through */
    }

    .toast {
        background: #333;
        color: #fff;
        padding: 10px 16px;
        border-radius: 6px;
        opacity: 0;
        transform: translateY(-10px);
        transition: all 0.4s ease;
        font-size: 0.95em;
        text-align: center;
        max-width: 90vw;
        min-width: 200px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        pointer-events: auto; /* toast itself clickable if needed */
    }
    .toast.show {
        opacity: 1;
        transform: translateY(0);
    }
    .toast:hover {
        opacity: 0.85;
        cursor: pointer;
    }
    .toast.success { background: #33b133; }
    .toast.error { background: #d9534f; }
    .toast.info { background: #555; }
    </style>
</head>
<body>
    <div id="toast-container"></div>
    <h1>POP-UP HANG</h1>
    <div id="desc" style="text-align: justify;">
        <p>Broadcast spontaneous hangouts to your friends or community.</p>
        <p>Every broadcast will expire after a set amount of time. (The unspecified duration broadcasts will expire after 12 hours.)</p>
        <p><em>The best way to use this tool is in a web browser (e.g. Safari). If you think you'll end the broadcast/"pop-up" early, leave this website open as a tab and click the "I'm Done" button at the bottom when you want to end things.</em></p>
    </div>
    <hr>
    <h2 style="text-align: center;">Current pop-ups</h2>
    <div class="spinner" id="loading-indicator">Loading</div>
    <div id="list"></div>
    <div id="no-listings" style="display:none;">There are no pop-ups at the moment.</div>
    <div id="last-updated"></div>
    <br>
    <hr>

    <div id="form">
        <h2 style="text-align: center;">Create a pop-up</h2>
        <form id="popup-form" autocomplete="off" novalidate>
            <label for="user">Name:</label><input id="user" name="user_name" placeholder="e.g. Phil Nguyen" autocomplete="name" inputmode="text" autocapitalize="words">
            <label for="note">Description/Location:</label><textarea id="note"name="popup_note" placeholder="e.g. Coffee at Pan Pan in Greenpoint" rows="3" autocomplete="off" autocorrect="on" spellcheck="true" autocapitalize="sentences" aria-label="Description of your hangout" style="width: 100%; margin: 0.4em 0; padding: 0.6em; border-radius: 5px; border: 1px solid #ccc; resize: vertical;"></textarea>
            <label for="duration">Duration:</label>
            <select name="duration" id="duration">
                <option value="1">1 hour</option>
                <option value="2" selected>2 hours</option>
                <option value="3">3 hours</option>
                <option value="unspecified">Unspecified</option>
            </select>
            <br>
            <br>
            <button type="button" onclick="getLocation()">üìç Share My Location (optional)</button>
            <input type="hidden" id="lat">
            <input type="hidden" id="lon">
            <button type="button" class="out" onclick="postBroadcast(event)">Create your pop-up</button>
            <p>To remove your listing early, click below:</p>
            <button type="button" class="done" onclick="deleteMyBroadcast(event)">Pop-up done!</button>
        </form>
    </div>
    <hr>
    <footer style="text-align: center;">
        <p><em>Created by <a href="https://philintheblank.me">Phil.</a></em></p>
    </footer>

    <script>
        // Generate a unique persistent device ID
    if (!localStorage.getItem("device_id")) {
        localStorage.setItem("device_id", crypto.randomUUID());
    }
    
    const device_id = localStorage.getItem("device_id");
    document.getElementById("popup-form").addEventListener("submit", e => e.preventDefault());
    
    const api = "/broadcasts";
    const spinner = document.getElementById("loading-indicator");
    
    // Toast helper: lightweight inline confirmation messages
    function showToast(message, type = "info", duration = 3000) {
        const container = document.getElementById("toast-container");
        const toast = document.createElement("div");
        toast.className = `toast ${type}`;
        toast.textContent = message;
        container.appendChild(toast);

        // Limit maximum visible toasts (optional)
        const toasts = container.querySelectorAll(".toast");
        if (toasts.length > 3) toasts[0].remove();

        // Click-to-dismiss
        toast.addEventListener("click", () => {
            toast.classList.remove("show");
            setTimeout(() => toast.remove(), 300);
        });

        // Trigger appearance animation
        setTimeout(() => toast.classList.add("show"), 50);

        // Auto-remove after duration
        setTimeout(() => {
            toast.classList.remove("show");
            setTimeout(() => toast.remove(), 400);
        }, duration);

        // Optional mobile vibration feedback
        if (type !== "info" && "vibrate" in navigator) navigator.vibrate(20);
    }


    function setLoading(show) {
        spinner.style.display = show ? "block" : "none";
    }

    async function postBroadcast(event) {        

        const btn = document.querySelector(".out");
        btn.disabled = true;
        const original = btn.textContent;
        btn.textContent = "Posting...";

        try {
            const user = document.getElementById("user").value.trim();
            const note = document.getElementById("note").value.trim();
            const durationValue = document.getElementById("duration").value;
            const duration_hours = durationValue === "unspecified" ? null : Number(durationValue);
            const lat = document.getElementById("lat").value || null;
            const lon = document.getElementById("lon").value || null;

            console.log("Sending payload:", { user, note, duration_hours, lat, lon });

            if (!user || !note) {
                showToast("Enter your name and description first.", "error");
                return;
            }

            localStorage.setItem("username", user);

            // Optimistic display
            const list = document.getElementById("list");
            const temp = document.createElement("div");
            temp.className = "broadcast new";
            temp.innerHTML = `<b>${user}</b> ‚Äî ${note} (posting...)`;
            list.prepend(temp);

            const res = await fetch("/broadcasts", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ user, note, duration_hours, lat, lon, device_id })
            });

            console.log("Response status:", res.status);

            if (!res.ok) {
                const txt = await res.text();
                console.warn("Server error:", txt);
                if (txt.includes("already have an active broadcast")) {
                    showToast("You already have an active pop-up!", "info");
                } else {
                    showToast("Could not post broadcast.", "error");
                }
                return;
            }

            const data = await res.json();
            if (data.delete_token) localStorage.setItem("delete_token", data.delete_token);

            document.getElementById("note").value = "";
            document.getElementById("lat").value = "";
            document.getElementById("lon").value = "";

            await loadBroadcasts();
            showToast("‚úÖ Listing posted!", "success");
        } catch (err) {
            console.error("Broadcast error:", err);
            showToast("Could not post broadcast. Try again.", "error");
        } finally {
            btn.disabled = false;
            btn.textContent = original;
        }
    }


    async function deleteMyBroadcast(event) {
      const token = localStorage.getItem("delete_token");
      if (!token) return showToast("No active broadcast found.");
      const btn = document.querySelector(".done");
      btn.disabled = true;
      const original = btn.textContent;
      btn.textContent = "Removing...";
      try {
        const res = await fetch("/delete_broadcast", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({ delete_token: token })
        });
        if (res.ok) {
          showToast("Your broadcast has been cleared!");
          localStorage.removeItem("delete_token");
          loadBroadcasts();
        } else {
          showToast("Could not delete broadcast. Maybe it already expired?");
        }
      } finally {
        btn.disabled = false;
        btn.textContent = original;
      }
    }

    function getLocation() {
        if (!navigator.geolocation) return showToast("Geolocation not supported.");

        navigator.geolocation.getCurrentPosition(
            pos => {
                document.getElementById("lat").value = pos.coords.latitude.toFixed(6);
                document.getElementById("lon").value = pos.coords.longitude.toFixed(6);
                showToast(`Location attached: (${pos.coords.latitude.toFixed(4)}, ${pos.coords.longitude.toFixed(4)})`);
            },
            err => {
            console.error("Location error:", err);
            let message = "Could not get location.";
            if (err.code === 1) message += " (Permission denied)";
            else if (err.code === 2) message += " (Position unavailable)";
            else if (err.code === 3) message += " (Timed out)";
            showToast(message);
            },
            {
            enableHighAccuracy: true,
            timeout: 15000,
            maximumAge: 0
            }
        );
    }

    async function loadBroadcasts() {
      setLoading(true);
      const res = await fetch(api);
      const data = await res.json();
      const list = document.getElementById("list");
      const noListings = document.getElementById("no-listings");
      const lastUpdated = document.getElementById("last-updated");
      list.innerHTML = "";

      if (data.length === 0) {
        noListings.style.display = "block";
      } else {
        noListings.style.display = "none";
        const now = new Date();
        data.forEach(b => {
          const div = document.createElement("div");
          div.className = "broadcast";

          const expTime = new Date(b.expires_at);
          const minsLeft = (expTime - now) / 60000;

          let line = `<b>${b.user}</b> ‚Äî ${b.note}`;
          if (b.duration_hours === null) {
            line += ` (time unspecified)`;
          } else {
            const end = expTime.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            if (minsLeft <= 30) {
              line += ` (until ${end}, <em>expiring soon</em>)`;
              div.classList.add("soon");
            } else {
              line += ` (until ${end})`;
            }
          }

          if (minsLeft <= 0) {
            div.classList.add("expired");
          }

          if (b.lat && b.lon) {
            const osm = `https://www.openstreetmap.org/?mlat=${b.lat}&mlon=${b.lon}#map=16/${b.lat}/${b.lon}`;
            line += ` <a href="${osm}" target="_blank">üìçMap</a>`;
          }

          div.innerHTML = line;
          list.appendChild(div);
        });
      }

      const nowTime = new Date();
      lastUpdated.textContent = `[Last updated: ${nowTime.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}]`;
      setLoading(false);
    }

    // ---------- SSE Live Updates ----------
    if ("EventSource" in window) {
        const evt = new EventSource("/stream");
        evt.addEventListener("new_broadcast", e => loadBroadcasts());
        evt.addEventListener("refresh", e => loadBroadcasts());
        setInterval(loadBroadcasts, 120000);
    } else {
        setInterval(loadBroadcasts, 120000);
    }

    document.getElementById("user").value = localStorage.getItem("username") || "";
    loadBroadcasts();
    </script>
</body>
</html>
